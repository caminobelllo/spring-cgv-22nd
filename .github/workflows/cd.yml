name: Deploy to AWS EC2

on:
  workflow_run:
    # CI 성공 시 수행
    workflows: [ "CGV clone CI" ]
    types:
      - completed

jobs:
  deploy:
    if: ${{github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-22.04

    env:
      REGISTRY: ${{ secrets.DOCKERHUB_USERNAME }}
      IMAGE: ${{ secrets.DOCKERHUB_REPOSITORY }}
      HEAD_SHA: ${{ github.event.workflow_run.head_sha }}
      APP_DIR: /home/ubuntu

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          envs: REGISTRY,IMAGE,TAG,APP_DIR,DOCKERHUB_USERNAME,DOCKERHUB_ACCESS_TOKEN
          script: |
            set -euo pipefail
            
            cd "$APP_DIR"
            
            test -f docker-compose.prod.yml || { echo "docker-compose.prod.yml not found in $APP_DIR"; exit 1; }
            test -f .env || { echo ".env not found in $APP_DIR"; exit 1; }
            
            echo "[1/4] Docker login"
            echo "${DOCKERHUB_ACCESS_TOKEN}" | sudo docker login -u "${DOCKERHUB_USERNAME}" --password-stdin
            
            echo "[2/4] Export variables for compose interpolation"
            export REGISTRY="${REGISTRY}"
            export IMAGE="${IMAGE}"
            export TAG="${TAG}"
            
            echo "[3/4] Pull & Up"
            sudo docker compose pull app || true
            sudo docker compose up -d
            
            echo "[4/4] Cleanup"
            sudo docker image prune -f
            
            echo "✅ Deployed ${REGISTRY}/${IMAGE}:${TAG}"